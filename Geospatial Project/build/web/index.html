<!DOCTYPE HTML>
<html>
<head>  
  

    <link rel="stylesheet" type="text/css" href="univers-else-font/stylesheet.css" />
    <script type="text/javascript" src="raphael.js"></script>
    <link type="text/css" href="jquery-ui-1.8.16.custom/css/ui-darkness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />
    <script type="text/javascript" src="jquery-ui-1.8.16.custom/js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.16.custom/js/jquery-ui-1.8.16.custom.min.js"></script>
    <script type="text/javascript" src="signals.js"></script>
     <script src="_js/jquery-1.8.0.min.js" type="text/javascript"></script>
        <script src="_js/jquery-ui-1.9.1.custom.min.js" type="text/javascript"></script>
        <script src="_js/step1Upload.js" type="text/javascript"></script>
        <link href="_css/jquery-ui-1.8.4.custom.css" rel="stylesheet" type="text/css" />
         <link rel="stylesheet" href="_css/jquery.sidr.dark.css">
    
    <script type="text/javascript" src="hasher.js"></script>
    <script type="text/javascript" src="modernizr.geoloc.js"></script>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script src="_js/jquery.sidr.min.js"></script>
    
</head>
<body>
<div style="display: table-cell" class="logo" style:"width:100%;height:40px;">
                                <img src="_images/logo.jpg" style="padding-left: 50px">
                                 </div>

<div id="container" >

<div id="inorout">
    <span id="in" class="on"><a href="#" class="blackLink">Inflows</a></span> 
    <span id="out"><a href="#" class="blackLink">Outflows</a></span>
</div>
    <div id="sidr" style="width:300px;">
  <!-- Your content -->
  <br/>
 <br/>
   <p><b>The map showcases the total number of inflows and outflows of the population across countries during the period from 1990 to 2000.</b>
  <br/>
  <br/>
  <b>Hover Over any country to see the critical parameters about the countries.</b>
    <br/>
  <br/>
  <b>Data Collected from <a href='data.worldbank.org'>World Bank</a></b>
  </p>
  
  <form action="./DataBaseCtrl?action=csvUpload" method="post" enctype="multipart/form-data" name="productForm" id="productForm">
                                                <br/>
                                                <div class="boxHeader" style="display:inline">
                                                    <br/>
                                                   <b>Step 1)</b> Upload Csv file: 
                                                        <br/>
                                                        <br/>
                                                        <input id="file" class="textbox" type="file" name="file"style="width:300px;"/>
                                                    <br/>
                                                    <br/>
                                                    <input type="submit" value="Upload" style="width: 60px; height: 25px;"/>
                                                </div>
                                            </form>
  <form action="./DataBaseCtrl?action=shpUpload" method="post" enctype="multipart/form-data" name="productForm" id="productForm">
                                    <div class="boxHeader" style="display:inline">
                                        <br/>
                                        <b>Step 2)</b> Upload Shape(.shp) File:
                                        <br/>
                                        <div style="padding-top: 10px">
                                            <input id="shapeFile" class="textbox" type="file" name="file"style="width:250px;"/>
                                        <br/>
                                        </div>
                                        <div style="padding-top: 10px">
                                            <input type="submit" value="Upload" style="width: 80px; height: 25px;"/>
                                           <br/>
                                           <br/>
                                           <br/>
                                        </div>
                                    </div>
                                </form>
   <div class="data_Entry_Title">
                                    <div class="boxHeader"><b><u>Shapefile Components:</u></b></div>
                                    <br/>
                                </div>                            
                                <table width="240">
                                    <thead>
                                        <tr class="paraHeader">
                                            <th class="ui-state-default paraCell">File Extension</th>
                                            <th class="ui-state-default paraCell">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="paraEstimateRow">
                                            <td id="shp" class="ui-widget-content"><b>.shp</b> (Required)</td>
                                            <td id="shpStatus" class="ui-widget-content" ></td>
                                        </tr> 
                                        <tr class="paraEstimateRow">
                                            <td id="shx" class="ui-widget-content"><b>.shx</b> (Required)</td>
                                            <td id="shxStatus" class="ui-widget-content" ></td>
                                        </tr>   
                                        <tr class="paraEstimateRow">
                                            <td id="dbf" class="ui-widget-content"><b>.dbf</b> (Required)</td>
                                            <td id="dbfStatus" class="ui-widget-content" ></td>
                                        </tr>  
                                        <tr class="paraEstimateRow">
                                            <td id="csv" class="ui-widget-content"><b>.csv</b></td>
                                            <td id="csvStatus" class="ui-widget-content" ></td>
                                        </tr>
                                        <tr class="paraEstimateRow">
                                            <td id="shpctg" class="ui-widget-content"><b>.shpctg</b></td>
                                            <td id="shpctgStatus" class="ui-widget-content" ></td>
                                        </tr>
                                        <tr class="paraEstimateRow">
                                            <td id="xml" class="ui-widget-content"><b>.xml</b></td>
                                            <td id="xmlStatus" class="ui-widget-content" ></td>
                                        </tr> 
                                    </tbody>       
                                </table>
  <div class="boxHeader" style="color: blue;">
      <br/>
      <br/>
  <a href="Step2.html" style="color:blue;"><h1><b>Analyze My Data!!</b></h1></a>
  </div>

 
</div>
 
<script>
$(document).ready(function() {
  $('#button').sidr({
          side:'right'
      });
      });
</script>
 

<div id="country_select_div" >
    <span id="explanation">Year Selector</span>
    <select id="year_select" onchange = "year_selector()">   
    <option value="1">Select Year</option>
    <option value="1990">1990</option>
    <option value="2000">2000</option>
    </select>
</div>
<div id="country_select_div">
    <span id="explanation">Country Selector</span>
    <select id="country_select">
    </select>
</div>
<div>
	<a id="button" href="#sidr"><h1>R Analysis</h1></a>
</div>

<div id="canvas_container" style="width:580px;">
    <script type="text/javascript">
        var ten_colors = ["#800026" , "#bd0026", "#e31a1c", "#fc4e2a", "#fd8d3c","#feb24c", "#fed976", "#ffeda0", "#FFFFB9","#FFFFE3"];
        var svg_borders;
        var current_arrows=[];
        var current_countries=[];
        var currentCircles=[];
        var currentCountry="Canada";
        var previousCountry = "Canada";
        var direction = "out";
        var unselected_color = "#F0FFFF";//for the colors of the countries when they are not selected or highlighted
        var selected_color = "#79BDBD";//"#67E667" ;//"#87ceeb";
        var border_color = "#DAA520";//for the border color of the countries
        var arrow_color = "#8BCFF3"//"#add8e6"; //"#fafad2";
        
        var code_to_coordinates;
        var userLatitude;
        var userLongitude;
        var GDP ={};
        var HIV = {};
        var POP = {};
        var TUBERCULOSIS = {};
        var UNDER_FIVE_MORTALITY = {};
        var container ;
        var paper = new Raphael(document.getElementById('canvas_container'), 1200, 600);

function year_selector()
{

    var year = document.getElementById('year_select');

if (year.options[year.selectedIndex].value === "1990")
{
var code_to_name ;
var name_to_code;


function parseHash(hash, redrawing){
            res = the_regexp.exec(hash);
            if (res)
            {
                currentCountry = res[1];
                if (res[2]=='inflows')
                    direction = 'out';
                else
                    direction = 'in';
            }
            if (redrawing)
            redraw();
        }

        function setHashSilently(hash){
            hasher.changed.active = false; //disable changed signal
            hasher.setHash(hash); //set hash without dispatching changed signal
            hasher.changed.active = true; //re-enable signal
        }
        function lolatoxy(point){
            var lo = point.longitude;
            var la = point.latitude;
           
            var x = (lo+180) * (1200 / 360.0);
            var y = (180 - (la+90)) *  (700.0 / 180.0); 
            return {"x":Math.floor(x),
                    "y":Math.floor(y)
            };
        }
        function flashCircles()
        {
            var c = paper.flashCircles(userLongitude,userLatitude , 1);
            c.attr({"stroke":"white"});
            c.animate({r: 30,stroke:""}, 333, function(){
                var d = paper.circle(userLongitude,userLatitude , 1);
                c.animate({r: 60,stroke:"white"}, 333);
                d.attr({"stroke":"white"});
                d.animate({r: 30,stroke:"yellow"},333, function(){
                    var e = paper.circle(userLongitude,userLatitude , 1);
                    e.attr({"stroke":"white"});
                    e.animate({r: 30,stroke:"yellow"}, 333);
                    c.animate({r: 90,stroke:"yellow"}, 333);
                    d.animate({r: 60,stroke:"white"},333, function(){
                        c.remove();
                        d.remove();
                        e.remove();
                    });
                });

            });
        }
        function redraw()
        {
            var other_direction = "in";
            var hash_direction = "inflows"
            if (direction =="in")
            {
                other_direction = "out";
                hash_direction = "outflows";
            }
            setHashSilently(currentCountry+"/"+hash_direction);
            removeCurrentDrawings();
            $("#country_select").val(currentCountry);
            draw_arrows_and_paint_countries();

            $("#"+direction).removeClass("on");
            $("#"+other_direction).addClass("on")
        }
        


        
        function color_country(country,color,strokeColor)//For country borders
        {
            var i;
            var l;
            if (svg_borders.hasOwnProperty(country))
                for (i=0, l= svg_borders[country].length;i<l;i++)
                {
                    if (strokeColor)//If the argument provides stroke colors then ok else make the border color as the strokecolor
                        svg_borders[country][i].animate({"fill":color,"stroke":strokeColor,"stroke-width":1},333);///333 indicates the time lag under which the color should be highlighted 
                    else
                        svg_borders[country][i].animate({"fill":color,"stroke":border_color,"stroke-width":2},333);
                }
        }

        function removeCurrentDrawings()//function to remove all the previous colors associated with any country or markers or lines when the country is changed
        {
            color_country(previousCountry,unselected_color);
            var i;
            var l;
            for (i=0,l=current_arrows.length;i<l;i++)
                current_arrows[i].remove();
            for (i=0,l=currentCircles.length;i<l;i++)
                currentCircles[i].remove();//remove all the currently highlighted circles

            current_arrows=[];
            for(i=0,l=current_countries.length;i<l;i++)
                color_country(current_countries[i],unselected_color);
            current_countries=[]
        }
        
        function get_click_handler(country){//to change the country name and redraw the map according to the new countru selected
            return function(){
                previousCountry = currentCountry;
                currentCountry = country;
                redraw();//redraws the whole map again reflecting the changeds made in this function
            }
        }
        
        function get_over_handler(country){//Important function
            return function(event){
                color_country(country,selected_color);
                var country_name =  $("#country_name_popup");

                country_name.empty();
                country_name.append("<span id='popup_country_name'>"+code_to_name[country] + "</span><table width='100%'>");
                var pop = insertDecimalPoints(parseFloat(POP[country]).toFixed(0));
                
                if (!pop || pop=="NaN")
                    pop = "no data";
                
                country_name.append("<tr><th>Population</th><td style='text-align:right;'>" + pop+'</td></tr>');
                var gdp = insertDecimalPoints(parseFloat(GDP[country]).toFixed(0)) ;
                if (gdp && !isNaN(gdp))
                    gdp = '$ '+gdp;
                else
                    gdp ="no data";
                country_name.append("<tr><th>GDP per capita</th><td style='text-align:right;'>" + gdp+'</td></tr>');
                //var gdp_education = insertDecimalPoints(parseFloat(GDP_EDUCATION[country]).toFixed(0));
                //if (gdp_education && !isNaN(gdp_education))
                  //  gdp_education = gdp_education + ' %';
                //else
                 //   gdp_education = "no data"
                //country_name.append("<tr><th>% GDP on expenditure</th><td style='text-align:right;'>" + gdp_education+'</td></tr>');
                var tb = parseFloat(TUBERCULOSIS[country]/1000).toFixed(2);
                if (tb && !isNaN(tb))
                    tb = tb + ' %';
                else
                    tb = "no data";
                country_name.append("<tr><th>Tuberculosis Prevalence</th><td style='text-align:right;'>" + tb +'</td></tr>');
                var mortality =  parseFloat(UNDER_FIVE_MORTALITY[country]/10).toFixed(2);
                if (mortality && !isNaN(mortality))
                    mortality = mortality + ' %';
                else
                    mortality = "no data";
                country_name.append("<tr><th>Mortality under Five</th><td style='text-align:right;'>" +mortality+'</td></tr></table>' );
                var unemployment = parseFloat(UNEMPLOYMENT[country]).toFixed(2);
                if (unemployment && !isNaN(unemployment))
                    unemployment = unemployment + ' %';
                else
                    unemployment = "no data";
                country_name.append("<tr><th>% Unemployment</th><td style='text-align:right;'>" + unemployment +'</td></tr>');
                var expectancy = parseFloat(LIFE_EXPECTANCY[country]).toFixed(2);
                if (expectancy && !isNaN(expectancy))
                    expectancy = expectancy + ' years';
                else
                    expectancy = "no data"
                country_name.append("<tr><th>Life Expectancy at birth  </th><td style='text-align:right;'>" + expectancy+'</td></tr>');


                country_name.css("display","block");
                var canvasContainer = $("#canvas_container");
                var canvasTop = canvasContainer.offset().top;
                var canvasLeft = canvasContainer.offset().left;
                if (event.pageY<canvasTop+500)
                    country_name.css("top",event.pageY);
                else
                    country_name.css("top",event.pageY-170);
                country_name.css("left",Math.min(event.pageX,canvasLeft+1200-290));
            }
        }
        function insertDecimalPoints(s)//insert commas in the population numbers shown in the legend
        {
            var l = s.length;
            var res = ""+s[0];
            for (var i=1;i<l-1;i++)
            {
                if ((l-i)%3==0)
                    res+= ",";
                res+=s[i];
            }
            res+=s[l-1];
            return res;
        }
        function get_out_handler(country){
            return function(event){
                var found=false;
                var i;
                var l;
                var country_name = $("#country_name_popup");
                country_name.css("display","none");
                for (i=0,l=current_countries.length;i<l;i++)
                {
                    if (country === current_countries[i])
                    {
                        found=true;
                        break;
                    }
                }
                if (country==currentCountry)
                    color_country(country,selected_color,'yellow');
                else if (found)
                  color_country(country,ten_colors[i])
                else
                    color_country(country,unselected_color);
            }
        }
        
        function draw_arrows_and_paint_countries()
        {

            $.getJSON("generated_1990/"+direction+currentCountry+".json", function(data) {//Awesome way to describe the data location 
                var countries_div = $("#countries");
                var country_name_div = $("#country_name");
                countries_div.empty();
                country_name_div.empty()
                country_name_div.append(code_to_name[currentCountry]);
                $("#popsize").empty();
                var popsize = insertDecimalPoints(parseFloat(POP[currentCountry]).toFixed(0));
                if (popsize!="NaN")
                    popsize = "Pop: "+popsize;
                if (popsize )
                    $("#popsize").append(popsize);
                var counter =0;
                $.each(data, function(country, val) {
                    var line;
                    var i;
                    var l;
                    var path;
                    var stroke = popsize/100000;
                  
                    line = paper.path(val[0]);
                    countries_div.append("<tr><td><div class=color_span style='height:1em;width:1em;background-color:"+ten_colors[counter] +" '>&nbsp;&nbsp;&nbsp;</div></td><td class='country_name' value='"+name_to_code[val[1]] +"'>"+val[1]+'</td><td style="text-align: right;">'+insertDecimalPoints(val[2])+"</td></tr>")
                    line.attr({stroke:arrow_color,'stroke-width':stroke,'opacity':0});
                    line.animate({stroke:arrow_color,'stroke-width':ten_colors[counter],'opacity':1},333);///333 shows the time delay it takes for the arrows to be fully highlighted
                    current_arrows.push(line);
                    color_country(country,ten_colors[counter]);
                    current_countries.push(country);
        
                    var coo = code_to_coordinates[country];
                    var circle = paper.circle(coo[0], coo[1], 3);//3 defines the overall radius of the circle for each country
                    circle.attr("stroke", "yellow");
                    circle.attr("fill", "red"); 
                    
                    //circle.attr("stroke", arrow_color);
                   //circle.attr("fill", border_color);
                   
                    currentCircles.push(circle);
                    coo = code_to_coordinates[currentCountry];
                    circle = paper.circle(coo[0], coo[1], 4);
                    circle.attr("stroke", "yellow");
                    circle.attr("fill", "red");
                    currentCircles.push(circle);
                    counter++;
                });

                color_country(currentCountry,selected_color,'yellow');
            });
        }

      

        $.getJSON('world_svg_paths_by_code.json', function(data) {
            svg_borders = {};
            $.each(data, function(country, val) {
                svg_borders[country]=[]
                var line;
                var i;
                var path;
                for (var i=0, l=val.length;i<l;i++)
                {
                    line = paper.path(val[i]);
                    line.attr({stroke:border_color,'stroke-width':2,'fill':unselected_color});//Attributes for the boundary lines of all the countries
                    line.country=country;
                    $(line.node).click( get_click_handler(country));//assigning click event to each country
                    $(line.node).mousemove( get_over_handler(country));///calling the mini floating legend for each country displaying all the other statistical details such as the population and etc.
                    $(line.node).mouseout( get_out_handler(country));

                    svg_borders[country].push(line);
                }
            });
             $.getJSON("name_to_code.json", function(data) {
                 name_to_code = data;
             });
             $.getJSON("GDP_1990.json", function(data) {
                 GDP = data;
             });
            $.getJSON("GDP_EDUCATION_1990.json", function(data) {
                 GDP_EDUCATION = data;
             });
            $.getJSON("TUBERCULOSIS_1990.json", function(data) {
                 TUBERCULOSIS = data;
             });
            $.getJSON("UNDER-FIVE-MORTALITY_1990.json", function(data) {
                 UNDER_FIVE_MORTALITY = data;
             });
            $.getJSON("POP_1990.json", function(data) {
                 POP = data;
             });
            $.getJSON("LIFE_EXPECTANCY_1990.json", function(data) {
                 LIFE_EXPECTANCY = data;
             });
            $.getJSON("UNEMPLOYMENT_1990.json", function(data) {
                 UNEMPLOYMENT = data;
             });

             $.getJSON("code_to_name.json", function(data) {
                 code_to_name = data;
                 var country_select = $("#country_select");
                 $.each(data, function(code, name) {
                     var selected='';
                     if (code=="BEL")
                        selected='selected="selected"';
                     country_select.append("<option value='"+code+"'" +selected+">"+name+'</option>');
                 });
                 country_select.change(function(e){
                    previousCountry = currentCountry;
                    currentCountry = $(this).val();
                    redraw();
                 });
                 //draw_arrows_and_paint_countries();
             });
            $.getJSON("code_to_coordinates.json", function(data) {
                code_to_coordinates = data;
                redraw();
            });


        });
        $(function(){
            if (!Modernizr.geolocation)
                $("#geoloc_me").hide();
            container = $("#container");
            $("#in").click(function(e){
               e.preventDefault();
               direction='out';
               redraw();
            });
            $("#out").click(function(e){
               e.preventDefault();

               direction='in';
               redraw();
            });
            $("#geoloc_me").click(function(e){
                navigator.geolocation.getCurrentPosition(function(data){
                    var userCoordinates = lolatoxy(data.coords);
                    userLatitude = userCoordinates.y;
                    userLongitude = userCoordinates.x;
                    flashCircles();
                });
            });
            $('#geoloc_me').hover(
                function() { $(this).addClass('ui-state-hover'); },
                function() { $(this).removeClass('ui-state-hover'); }
            );
            $('#legend').draggable();
            $("#legend").delegate(".country_name","click",function(e){
                previousCountry = currentCountry;
                currentCountry = $(this).attr("value");
                redraw();
            });
            $("#legend").delegate(".country_name","mouseenter",function(e){
                $(this).css("text-decoration","underline");
            });
            $("#legend").delegate(".country_name","mouseleave",function(e){
                $(this).css("text-decoration","none");
            });
        });
            
        var the_regexp = /^([^\/\?]+)\/?(\w*)$/i;
        hasher.initialized.add(parseHash);
        hasher.changed.add(parseHash, true);
        hasher.init(); //start listening for history change
        
}
if (year.options[year.selectedIndex].value === "2000")

{

var code_to_name ;
var name_to_code;
    function parseHash1(hash, redrawing){
            res = the_regexp.exec(hash);
            if (res)
            {
                currentCountry = res[1];
                if (res[2]=='inflows')
                    direction = 'out';
                else
                    direction = 'in';
            }
            if (redrawing)
            redraw();
        }

        function setHashSilently1(hash){
            hasher.changed.active = false; //disable changed signal
            hasher.setHash(hash); //set hash without dispatching changed signal
            hasher.changed.active = true; //re-enable signal
        }
        function lolatoxy1(point){
            var lo = point.longitude;
            var la = point.latitude;
           
            var x = (lo+180) * (1200 / 360.0);
            var y = (180 - (la+90)) *  (700.0 / 180.0); 
            return {"x":Math.floor(x),
                    "y":Math.floor(y)
            };
        }
        function flashCircles1()
        {
            var c = paper.flashCircles(userLongitude,userLatitude , 1);
            c.attr({"stroke":"white"});
            c.animate({r: 30,stroke:""}, 100, function(){
                var d = paper.circle(userLongitude,userLatitude , 1);
                c.animate({r: 60,stroke:"white"}, 333);
                d.attr({"stroke":"white"});
                d.animate({r: 30,stroke:"yellow"},333, function(){
                    var e = paper.circle(userLongitude,userLatitude , 1);
                    e.attr({"stroke":"white"});
                    e.animate({r: 30,stroke:"yellow"}, 333);
                    c.animate({r: 90,stroke:"yellow"}, 333);
                    d.animate({r: 60,stroke:"white"},333, function(){
                        c.remove();
                        d.remove();
                        e.remove();
                    });
                });

            });
        }
        function redraw1()
        {
            var other_direction = "in";
            var hash_direction = "inflows"
            if (direction =="in")
            {
                other_direction = "out";
                hash_direction = "outflows";
            }
            setHashSilently1(currentCountry+"/"+hash_direction);
            removeCurrentDrawings1();
            $("#country_select").val(currentCountry);
            draw_arrows_and_paint_countries1();

            $("#"+direction).removeClass("on");
            $("#"+other_direction).addClass("on")
        }
        


        
        function color_country1(country,color,strokeColor)//For country borders
        {
            var i;
            var l;
            if (svg_borders.hasOwnProperty(country))
                for (i=0, l= svg_borders[country].length;i<l;i++)
                {
                    if (strokeColor)//If the argument provides stroke colors then ok else make the border color as the strokecolor
                        svg_borders[country][i].animate({"fill":color,"stroke":strokeColor,"stroke-width":1},333);///333 indicates the time lag under which the color should be highlighted 
                    else
                        svg_borders[country][i].animate({"fill":color,"stroke":border_color,"stroke-width":2},333);
                }
        }

        function removeCurrentDrawings1()//function to remove all the previous colors associated with any country or markers or lines when the country is changed
        {
            color_country1(previousCountry,unselected_color);
            var i;
            var l;
            for (i=0,l=current_arrows.length;i<l;i++)
                current_arrows[i].remove();
            for (i=0,l=currentCircles.length;i<l;i++)
                currentCircles[i].remove();//remove all the currently highlighted circles

            current_arrows=[];
            for(i=0,l=current_countries.length;i<l;i++)
                color_country1(current_countries[i],unselected_color);
            current_countries=[]
        }
        
        function get_click_handler1(country){//to change the country name and redraw the map according to the new countru selected
            return function(){
                previousCountry = currentCountry;
                currentCountry = country;
                redraw1();//redraws the whole map again reflecting the changeds made in this function
            }
        }
        
        function get_over_handler1(country){//Important function
            return function(event){
                color_country1(country,selected_color);
                var country_name =  $("#country_name_popup");

                country_name.empty();
                country_name.append("<span id='popup_country_name'> "+code_to_name[country] + "</span><table width='100%'>");
                var pop = insertDecimalPoints1(parseFloat(POP[country]).toFixed(0));
                
                if (!pop || pop=="NaN")
                    pop = "no data";
                
                country_name.append("<tr><th>Population</th><td style='text-align:right;'>" + pop+'</td></tr>');
                var gdp = insertDecimalPoints1(parseFloat(GDP[country]).toFixed(0)) ;
                if (gdp && !isNaN(gdp))
                    gdp = '$ '+gdp;
                else
                    gdp ="no data";
                country_name.append("<tr><th>GDP per capita</th><td style='text-align:right;'>" + gdp+'</td></tr>');
                var gdp_education = GDP_EDUCATION[country];
                if (gdp_education && !isNaN(gdp_education))
                    gdp_education = gdp_education + ' %';
                else
                    gdp_education = "no data"
                country_name.append("<tr><th>% GDP on expenditure</th><td style='text-align:right;'>" + gdp_education+'</td></tr>');
                var tb = parseFloat(TUBERCULOSIS[country]/1000).toFixed(2);
                if (tb && !isNaN(tb))
                    tb = tb + ' %';
                else
                    tb = "no data";
                country_name.append("<tr><th>Tuberculosis Prevalence</th><td style='text-align:right;'>" + tb +'</td></tr>');
                var mortality =  parseFloat(UNDER_FIVE_MORTALITY[country]/10).toFixed(2);
                if (mortality && !isNaN(mortality))
                    mortality = mortality + ' %';
                else
                    mortality = "no data";
                country_name.append("<tr><th>Mortality under Five</th><td style='text-align:right;'>" +mortality+'</td></tr></table>' );
                var unemployment = parseFloat(UNEMPLOYMENT[country]).toFixed(2);
                if (unemployment && !isNaN(unemployment))
                    unemployment = unemployment + ' %';
                else
                    unemployment = "no data";
                country_name.append("<tr><th>% Unemployment</th><td style='text-align:right;'>" + unemployment +'</td></tr>');
                var expectancy = parseFloat(LIFE_EXPECTANCY[country]).toFixed(2);
                if (expectancy && !isNaN(expectancy))
                    expectancy = expectancy + ' years';
                else
                    expectancy = "no data"
                country_name.append("<tr><th>Life Expectancy at birth</th><td style='text-align:right;'>" + expectancy+'</td></tr>');



                country_name.css("display","block");
                var canvasContainer = $("#canvas_container");
                var canvasTop = canvasContainer.offset().top;
                var canvasLeft = canvasContainer.offset().left;
                if (event.pageY<canvasTop+500)
                    country_name.css("top",event.pageY);
                else
                    country_name.css("top",event.pageY-170);
                country_name.css("left",Math.min(event.pageX,canvasLeft+1200-290));
            }
        }
        function insertDecimalPoints1(s)//insert commas in the population numbers shown in the legend
        {
            var l = s.length;
            var res = ""+s[0];
            for (var i=1;i<l-1;i++)
            {
                if ((l-i)%3==0)
                    res+= ",";
                res+=s[i];
            }
            res+=s[l-1];
            return res;
        }
        function get_out_handler1(country){
            return function(event){
                var found=false;
                var i;
                var l;
                var country_name = $("#country_name_popup");
                country_name.css("display","none");
                for (i=0,l=current_countries.length;i<l;i++)
                {
                    if (country === current_countries[i])
                    {
                        found=true;
                        break;
                    }
                }
                if (country==currentCountry)
                    color_country1(country,selected_color,'yellow');
                else if (found)
                  color_country1(country,ten_colors[i])
                else
                    color_country1(country,unselected_color);
            }
        }
        
        function draw_arrows_and_paint_countries1()
        {

            $.getJSON("generated_2000/"+direction+currentCountry+".json", function(data) {//Awesome way to describe the data location 
                var countries_div = $("#countries");
                var country_name_div = $("#country_name");
                countries_div.empty();
                country_name_div.empty()
                country_name_div.append(code_to_name[currentCountry]);
                $("#popsize").empty();
                var popsize = insertDecimalPoints1(parseFloat(POP[currentCountry]).toFixed(0));
                if (popsize!="NaN")
                    popsize = "Pop: "+popsize;
                if (popsize )
                    $("#popsize").append(popsize);
                var counter =0;
                $.each(data, function(country, val) {
                    var line;
                    var i;
                    var l;
                    var path;
                    var stroke = popsize/100000;
                  
                    line = paper.path(val[0]);
                    countries_div.append("<tr><td><div class=color_span style='height:1em;width:1em;background-color:"+ten_colors[counter] +" '>&nbsp;&nbsp;&nbsp;</div></td><td class='country_name' value='"+name_to_code[val[1]] +"'>"+val[1]+'</td><td style="text-align: right;">'+insertDecimalPoints1(val[2])+"</td></tr>")
                    line.attr({stroke:arrow_color,'stroke-width':stroke,'opacity':0});
                    line.animate({stroke:arrow_color,'stroke-width':ten_colors[counter],'opacity':1},333);///333 shows the time delay it takes for the arrows to be fully highlighted
                    current_arrows.push(line);
                    color_country1(country,ten_colors[counter]);
                    current_countries.push(country);
        
                    var coo = code_to_coordinates[country];
                    var circle = paper.circle(coo[0], coo[1], 3);//3 defines the overall radius of the circle for each country
                    circle.attr("stroke", "yellow");
                    circle.attr("fill", "red"); 
                    
                    //circle.attr("stroke", arrow_color);
                   //circle.attr("fill", border_color);
                   
                    currentCircles.push(circle);
                    coo = code_to_coordinates[currentCountry];
                    circle = paper.circle(coo[0], coo[1], 4);
                    circle.attr("stroke", "yellow");
                    circle.attr("fill", "red");
                    currentCircles.push(circle);
                    counter++;
                });

                color_country1(currentCountry,selected_color,'yellow');
            });
        }



        $.getJSON('world_svg_paths_by_code.json', function(data) {
            svg_borders = {};
            $.each(data, function(country, val) {
                svg_borders[country]=[]
                var line;
                var i;
                var path;
                for (var i=0, l=val.length;i<l;i++)
                {
                    line = paper.path(val[i]);
                    line.attr({stroke:border_color,'stroke-width':2,'fill':unselected_color});//Attributes for the boundary lines of all the countries
                    line.country=country;
                    $(line.node).click( get_click_handler1(country));//assigning click event to each country
                    $(line.node).mousemove( get_over_handler1(country));///calling the mini floating legend for each country displaying all the other statistical details such as the population and etc.
                    $(line.node).mouseout( get_out_handler1(country));

                    svg_borders[country].push(line);
                }
            });
            $.getJSON("name_to_code.json", function(data) {
                 name_to_code = data;
             });
             $.getJSON("GDP_2000.json", function(data) {
                 GDP = data;
             });
            $.getJSON("GDP_EDUCATION_2000.json", function(data) {
                 GDP_EDUCATION = data;
             });
            $.getJSON("TUBERCULOSIS_2000.json", function(data) {
                 TUBERCULOSIS = data;
             });
            $.getJSON("UNDER-FIVE-MORTALITY_2000.json", function(data) {
                 UNDER_FIVE_MORTALITY = data;
             });
            $.getJSON("POP_2000.json", function(data) {
                 POP = data;
             });
            $.getJSON("LIFE_EXPECTANCY_2000.json", function(data) {
                 LIFE_EXPECTANCY = data;
             });
            $.getJSON("UNEMPLOYMENT_2000.json", function(data) {
                 UNEMPLOYMENT = data;
             });

             $.getJSON("code_to_name.json", function(data) {
                 code_to_name = data;
                 var country_select = $("#country_select");
                 $.each(data, function(code, name) {
                     var selected='';
                     if (code=="BEL")
                        selected='selected="selected"';
                     country_select.append("<option value='"+code+"'" +selected+">"+name+'</option>');
                 });
                 country_select.change(function(e){
                    previousCountry = currentCountry;
                    currentCountry = $(this).val();
                    redraw1();
                 });
                 //draw_arrows_and_paint_countries1();
             });
            $.getJSON("code_to_coordinates.json", function(data) {
                code_to_coordinates = data;
                redraw1();
            });


        });
        $(function(){
            if (!Modernizr.geolocation)
                $("#geoloc_me").hide();
            container = $("#container");
            $("#in").click(function(e){
               e.preventDefault();
               direction='out';
               redraw1();
            });
            $("#out").click(function(e){
               e.preventDefault();

               direction='in';
               redraw1();
            });
            $("#geoloc_me").click(function(e){
                navigator.geolocation.getCurrentPosition(function(data){
                    var userCoordinates = lolatoxy1(data.coords);
                    userLatitude = userCoordinates.y;
                    userLongitude = userCoordinates.x;
                    flashCircles1();
                });
            });
            $('#geoloc_me').hover(
                function() { $(this).addClass('ui-state-hover'); },
                function() { $(this).removeClass('ui-state-hover'); }
            );
            $('#legend').draggable();
            $("#legend").delegate(".country_name","click",function(e){
                previousCountry = currentCountry;
                currentCountry = $(this).attr("value");
                redraw1();
            });
            $("#legend").delegate(".country_name","mouseenter",function(e){
                $(this).css("text-decoration","underline");
            });
            $("#legend").delegate(".country_name","mouseleave",function(e){
                $(this).css("text-decoration","none");
            });
        });
            
        var the_regexp = /^([^\/\?]+)\/?(\w*)$/i;
        hasher.initialized.add(parseHash1);
        hasher.changed.add(parseHash1, true);
        hasher.init(); //start listening for history change
       
}
}

        
    </script>
</div>
<div id="legend" style:"color:#ffffff;">
    <h2 id="country_name">
    </h2>
    <h3 id="popsize">
    </h3>
        <table id="countries" width="100%">
        </table>
</div>
<div id="country_name_popup">
</div>
  

<div id="acknowledment" style="left:45px;">
    
    <b>Special Thanks to Prof. Kam Tin Seong, Joseph Tay Choon Kiat and Madewulf(Github)</b>
    </div>
</div>
</body>
</html>
